name: Daily ACR Intel Digest

on:
  schedule:
    # Run at 6 AM ET (11:00 UTC) every day
    - cron: '0 11 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  daily-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Run Daily Pipeline
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "Starting daily ACR Intel pipeline..."

          # Step 1: Ingest
          echo "Step 1: Ingesting RSS feeds..."
          curl -s -X POST "https://${VERCEL_URL}/api/ingest" \
            -H "Content-Type: application/json" | jq .

          # Wait for ingestion to complete
          sleep 30

          # Step 2: Summarize
          echo "Step 2: Summarizing new items..."
          curl -s -X POST "https://${VERCEL_URL}/api/summarize" \
            -H "Content-Type: application/json" | jq .

          # Wait for summarization (can take a while with many items)
          sleep 180

          # Step 3: Generate and send digest
          echo "Step 3: Generating and sending digest..."
          curl -s -X POST "https://${VERCEL_URL}/api/digest" \
            -H "Content-Type: application/json" | jq .

          echo "Daily pipeline complete!"
